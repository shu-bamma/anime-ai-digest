# Agent Contracts

Every agent in this system follows these contracts. If you're implementing a new agent or modifying an existing one, follow these rules.

## Fetcher Contract

### Individual Source Fetcher

Every source fetcher is a Python module in `agents/fetcher/sources/` that exposes:

```python
def fetch() -> list[dict]:
    """
    Fetch items from this source.
    
    Returns a list of FetchItem dicts. Each dict must have:
    {
        "source_id": str,           # Unique source identifier (e.g. "github_wan_video")
        "source_category": str,     # One of: "models", "industry", "community", "youtube", "legal"
        "title": str,               # Item title (original language)
        "url": str,                 # Canonical URL to the item
        "published_at": str | None, # ISO 8601 UTC timestamp, or None if unknown
        "raw_body": str | None,     # Full text content (optional)
        "original_language": str,   # ISO 639-1 code: "en", "ja", "zh", "ko"
        "metadata": dict,           # Source-specific data (stars, downloads, tags, etc.)
    }
    
    On failure: returns empty list [], never raises.
    Must log errors via logging module.
    """
```

### Rules for Source Fetchers
1. **Never crash.** Wrap everything in try/except. Return `[]` on failure.
2. **Log errors** with source_id and error message.
3. **Respect rate limits.** Add sleeps between requests if needed.
4. **Return all items** found in the time window â€” dedup happens upstream.
5. **Don't translate.** Return original language text. Translation is a separate step.
6. **Timestamps in UTC ISO 8601.** Use `datetime.utcnow().isoformat() + "Z"`.

### Fetcher Main (`agents/fetcher/main.py`)

Orchestrates all source fetchers:

```python
def run_fetcher() -> dict:
    """
    Run all enabled source fetchers.
    
    1. Create a digest_run record in Supabase
    2. Call each source fetcher's fetch() function
    3. Deduplicate items against existing Supabase items (by content_hash)
    4. Translate non-English titles/bodies
    5. Insert new items into Supabase
    6. Update digest_run with stats
    
    Returns: {"run_id": str, "items_fetched": int, "items_new": int, "errors": list}
    """
```

## Scorer Contract

```python
def run_scorer(run_id: str) -> dict:
    """
    Score all items from a given digest run.
    
    1. Read items fetched in this run from Supabase
    2. Compute weighted score for each item:
       - recency_score: based on published_at (0-1)
       - engagement_score: based on metadata (stars, downloads, etc.) (0-1)
       - keyword_score: keyword relevance boost (0-1)
       - source_priority_score: based on source category (0-1)
       - total_score = weighted sum of components
    3. Write scores to Supabase scores table
    
    Returns: {"items_scored": int}
    """
```

### Scoring Weights (suggested starting point â€” tune as needed)
- Recency: 0.25
- Engagement: 0.25
- Keyword relevance: 0.30
- Source priority: 0.20

### Keyword Lists for Scoring

**High boost (anime/webtoon specific):**
anime, webtoon, manga, manhwa, visual novel, ren'py, renpy, twine, 
interactive fiction, sakuga, cel shading, 2d animation, character consistency,
studio ghibli, anisora, waifu, chibi, shonen, shojo, isekai

**Medium boost (AI video general):**
wan2, hunyuanvideo, cogvideo, ltx-video, open-sora, skyreels, animatediff,
comfyui, lora, controlnet, i2v, t2v, image-to-video, text-to-video,
video generation, diffusion, motion, temporal

**Low boost (broader context):**
copyright, training data, open source, apache 2.0, benchmark, vram,
inference, model release, fine-tune, gguf, fp8, quantized

## Renderer Contract

```python
def run_renderer(run_id: str) -> dict:
    """
    Generate the daily digest from scored items.
    
    1. Read top-scored items for this run from Supabase (join items + scores)
    2. Group items by source_category
    3. Render Markdown digest (outputs/YYYY-MM-DD.md)
    4. Render HTML digest (outputs/YYYY-MM-DD.html) using template
    5. Update digest_run with output paths
    
    Returns: {"md_path": str, "html_path": str}
    """
```

### Digest Structure

```markdown
# Anime AI Video Digest â€” YYYY-MM-DD

## ğŸ¬ Model Releases & Updates
- [Item title](url) â€” 1-line description
  - Source: GitHub | â­ 1,234 | Published: 2h ago

## ğŸ“° Industry News
- ...

## ğŸ¨ Community & Workflows
- ...

## ğŸ“º YouTube
- ...

## âš–ï¸ Copyright & Legal
- ...

---
*Generated by anime-ai-digest â€¢ [Source](repo_url)*
```

### HTML Template Requirements
- Mobile-first responsive design
- Dark mode support
- Collapsible sections per category
- Links open in new tab
- Minimal CSS (inline or single <style> block)
- No JavaScript dependencies (optional vanilla JS for collapse)
